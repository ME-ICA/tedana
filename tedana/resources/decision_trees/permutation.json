{
    "tree_id": "permutation_decision_tree",
    "info": "Decision tree using permutation test p-values for component classification",
    "report": "The permutation decision tree uses spatially-specific TE-dependence testing via permutation \\citep{tedana_decision_trees}. Unlike traditional kappa/rho metrics which measure global TE-dependence, the permutation test evaluates whether each component's echo-wise structure specifically matches local T2* sensitivity patterns under a linearized signal model. Low p_t2 values indicate spatial alignment consistent with BOLD-like signal; low p_s0 values indicate alignment consistent with S0-driven fluctuations. Note that T2*-alignment is a necessary but not sufficient condition for neuronal BOLD signal.",
    "necessary_metrics": [
        "kappa",
        "rho",
        "kappa_dominance",
        "rho_dominance",
        "kappa_star_perm",
        "rho_star_perm",
        "p_t2",
        "p_s0",
        "r2_full",
        "variance explained"
    ],
    "intermediate_classifications": ["provisionalaccept", "provisionalreject"],
    "classification_tags": [
        "T2*-aligned (strong)",
        "T2*-aligned (moderate)",
        "T2*-aligned",
        "T2*-dominant",
        "Mixed T2*/S0",
        "S0-aligned",
        "S0-dominant",
        "Non-specific TE pattern",
        "Poor model fit",
        "Low variance",
        "Unclassified rejected"
    ],
    "_comment": "This decision tree uses permutation-based p-values (p_t2 and p_s0) to test whether components show spatially-specific TE-dependence under a linearized model. Low p_t2 indicates the component's echo-wise pattern is spatially aligned with local T2* sensitivity (consistent with BOLD-like signal). Low p_s0 indicates alignment with local S0 sensitivity (consistent with S0-driven fluctuations). The combination of kappa_star_perm (descriptive variance fraction) and p-values (inferential) provides robust classification.",
    "nodes": [
        {
            "functionname": "manual_classify",
            "parameters": {"new_classification": "unclassified", "decide_comps": "all"},
            "kwargs": {
                "clear_classification_tags": true,
                "dont_warn_reclassify": true
            },
            "_comment": "All components are initially labeled as 'unclassified'."
        },
        {
            "functionname": "calc_median",
            "parameters": {
                "decide_comps": "all",
                "metric_name": "variance explained",
                "median_label": "varex"
            },
            "_comment": "Calculate median variance explained for later thresholding."
        },
        {
            "functionname": "dec_left_op_right",
            "parameters": {
                "if_true": "rejected",
                "if_false": "nochange",
                "decide_comps": "all",
                "left": "rho_star_perm",
                "op": ">",
                "right": 0.5
            },
            "kwargs": {
                "tag_if_true": "S0-dominant"
            },
            "_comment": "Reject components that are primarily S0-driven: higher rho_star_perm than kappa_star_perm. These are consistent with S0-driven fluctuations (e.g., physiological noise from respiration or cardiac pulsation)."
        },
        {
            "functionname": "dec_left_op_right",
            "parameters": {
                "if_true": "accepted",
                "if_false": "nochange",
                "decide_comps": "unclassified",
                "left": "p_t2",
                "op": ">",
                "right": 0.05
            },
            "kwargs": {
                "left2": "p_s0",
                "op2": ">",
                "right2": 0.05,
                "tag_if_true": "Non-specific TE pattern"
            },
            "_comment": "Accept components with no spatially-specific TE-dependence (both p_t2 > 0.05 AND p_s0 > 0.05). These components have echo-wise structure that doesn't match local T2* or S0 patterns, suggesting non-physiological noise."
        },
        {
            "functionname": "dec_left_op_right",
            "parameters": {
                "if_true": "rejected",
                "if_false": "nochange",
                "decide_comps": "unclassified",
                "left": "r2_full",
                "op": "<",
                "right": 0.2
            },
            "kwargs": {
                "tag_if_true": "Poor model fit"
            },
            "_comment": "Reject components where the linearized monoexponential model explains very little echo-wise variance (RÂ² < 0.2). If the model doesn't fit, the p-values are not meaningful, and the component's echo-wise structure is inconsistent with both BOLD and S0-driven signal."
        },
        {
            "functionname": "dec_left_op_right",
            "parameters": {
                "if_true": "provisionalaccept",
                "if_false": "nochange",
                "decide_comps": "unclassified",
                "left": "kappa_star_perm",
                "op": ">",
                "right": 0.8
            },
            "kwargs": {
                "left2": "p_t2",
                "op2": "<",
                "right2": 0.05,
                "tag_if_true": "T2*-aligned (strong)"
            },
            "_comment": "Provisionally accept components that are strongly T2*-driven: high kappa_star_perm (> 0.8) AND significant T2* spatial specificity (p_t2 < 0.05). Mixed components were already handled above."
        },
        {
            "functionname": "dec_left_op_right",
            "parameters": {
                "if_true": "provisionalreject",
                "if_false": "nochange",
                "decide_comps": "unclassified",
                "left": "p_t2",
                "op": "<",
                "right": 0.05
            },
            "kwargs": {
                "left2": "p_s0",
                "op2": "<",
                "right2": 0.05,
                "tag_if_true": "Mixed T2*/S0"
            },
            "_comment": "Provisionally reject components with BOTH significant T2* AND S0 spatial specificity. These mixed-signal components have ambiguous character - the spatial specificity for both bases could indicate artifact with structure correlated to T2* maps rather than genuine BOLD. This must come BEFORE the T2*-aligned acceptance nodes."
        },
        {
            "functionname": "dec_left_op_right",
            "parameters": {
                "if_true": "provisionalaccept",
                "if_false": "nochange",
                "decide_comps": "unclassified",
                "left": "kappa_star_perm",
                "op": ">",
                "right": 0.5
            },
            "kwargs": {
                "left2": "p_t2",
                "op2": "<",
                "right2": 0.05,
                "tag_if_true": "T2*-aligned (moderate)"
            },
            "_comment": "Provisionally accept remaining unclassified components with moderate-to-high T2* dominance (kappa_star_perm > 0.5) AND significant T2* spatial specificity (p_t2 < 0.05). Mixed components were already handled above."
        },
        {
            "functionname": "dec_left_op_right",
            "parameters": {
                "if_true": "accepted",
                "if_false": "nochange",
                "decide_comps": "provisionalaccept",
                "op": ">",
                "left": "kappa_star_perm",
                "right": "rho_star_perm"
            },
            "kwargs": {"right_scale": 2, "tag_if_true": "T2*-dominant"},
            "_comment": "Accept provisionally accepted components where kappa_star_perm is at least twice rho_star_perm. Strong T2* dominance is consistent with BOLD-like signal."
        },
        {
            "functionname": "dec_variance_lessthan_thresholds",
            "parameters": {
                "if_true": "accepted",
                "if_false": "nochange",
                "decide_comps": "provisionalreject"
            },
            "kwargs": {
                "var_metric": "variance explained",
                "single_comp_threshold": 0.1,
                "all_comp_threshold": 1.0,
                "tag_if_true": "Low variance"
            },
            "_comment": "Accept low-variance provisionally rejected components (< 0.1% each, up to 1% total). These don't explain enough variance to be worth rejecting."
        },
        {
            "functionname": "manual_classify",
            "parameters": {
                "new_classification": "accepted",
                "decide_comps": ["provisionalaccept", "unclassified"]
            },
            "kwargs": {"tag": "T2*-aligned"},
            "_comment": "Accept all remaining provisionally accepted and unclassified components."
        },
        {
            "functionname": "manual_classify",
            "parameters": {
                "new_classification": "rejected",
                "decide_comps": ["provisionalreject"]
            },
            "kwargs": {"tag": "Unclassified rejected"},
            "_comment": "Reject all remaining provisionally rejected components."
        }
    ]
}
